#!/data/data/com.termux/files/usr/bin/sh

# Widget Shortcut: Backup
# File: ~/.shortcuts/backup
# Purpose: Backup important files to storage

BACKUP_DIR="/sdcard/termux-backups"
DATE=$(date +%Y%m%d_%H%M%S)

# Default exclusions - add or remove items as needed
# Can also use ~/.termux/backup-excludes file (one item per line)
EXCLUDES="
.cache
node_modules
.termux
.local
.git
Downloads
tmp
.android
.gradle
.cargo
go
"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Build tar exclude arguments from default exclusions
EXCLUDE_ARGS=""
for item in $EXCLUDES; do
    [ -n "$item" ] && EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude='$item'"
done

# Add user exclusions from file if it exists
if [ -f "$HOME/.termux/backup-excludes" ]; then
    while IFS= read -r line; do
        [ -n "$line" ] && EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude='$line'"
    done < "$HOME/.termux/backup-excludes"
fi

# Backup home directory
echo "Creating backup..."

# Get size estimate for progress bar
SIZE=$(du -sb "$HOME" 2>/dev/null | cut -f1) || SIZE=100000000

# tar -> pv -> gzip for progress bar
tar cf - -C "$HOME" . $EXCLUDE_ARGS 2>/dev/null \
    | pv -lep -s "$SIZE" \
    | gzip > "$BACKUP_DIR/home_$DATE.tar.gz"

# Notify user
if [ -f "$BACKUP_DIR/home_$DATE.tar.gz" ]; then
    echo "Backup complete: home_$DATE.tar.gz"
    termux-notification -t "Backup Complete" -c "Saved to $BACKUP_DIR"
else
    echo "Backup failed!"
    termux-notification -t "Backup Failed" -c "Check terminal for errors"
fi
